/* jsPsych Lightweight Runtime (Custom Build for Panel-Click Experiment)
   Compatible with jsPsych.initJsPsych(), data API, plugin runner.
   This file replaces jspsych.umd.min.js for GitHub Pages hosting. */

(function (root) {
  const jsPsych = {
    timeline: [],
    data_storage: [],

    /** データAPI */
    data: {
      _data: [],
      add(d) { this._data.push(d); },
      get() { return this._data; },
      displayData() {
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(this._data, null, 2);
        document.body.innerHTML = "";
        document.body.appendChild(pre);
      }
    },

    /** initJsPsych */
    initJsPsych(params = {}) {
      jsPsych._on_finish = params.on_finish || function(){};
      jsPsych._display = params.display_element || document.body;
      return jsPsych;
    },

    /** プラグイン登録 */
    plugins: {},

    /** プラグイン実行 */
    run(timeline) {
      jsPsych.timeline = timeline.slice();
      jsPsych._runNext();
    },

    _runNext() {
      if (jsPsych.timeline.length === 0) {
        jsPsych._on_finish();
        return;
      }
      const trial = jsPsych.timeline.shift();
      const plugin = jsPsych.plugins[trial.type];

      if (!plugin) {
        console.error("Plugin not found:", trial.type);
        jsPsych._runNext();
        return;
      }

      plugin.trial(jsPsych._display, trial);
    },

    /** 1試行終了 */
    finishTrial(data) {
      jsPsych.data.add(data || {});
      jsPsych._runNext();
    }
  };

  /** html-button-response の簡易内蔵版 */
  jsPsych.plugins["html-button-response"] = {
    trial(display_element, trial) {
      display_element.innerHTML = `
        <div style="text-align:center;margin-top:80px;">
          ${trial.stimulus}
          <div style="margin-top:20px;">
            ${trial.choices.map((c,i)=>`<button id="btn${i}" style="margin:5px;padding:8px 20px;">${c}</button>`).join("")}
          </div>
        </div>
      `;

      trial.choices.forEach((c,i)=>{
        document.getElementById("btn"+i).onclick = () => {
          jsPsych.finishTrial({choice:c, time:Date.now()});
        };
      });
    }
  };

  // expose
  root.jsPsych = jsPsych;

})(this);
